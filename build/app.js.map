{"version":3,"sources":["../src/app.ts"],"sourcesContent":["import 'express-async-errors';\n// import \"reflect-metadata\";\nimport express, { Application, NextFunction, Request, Response } from 'express';\n\nimport { UserController } from './controllers/users/user.controller.js';\nimport AuthController from './controllers/auth/auth.controller.js';\nimport { RoutingControllersOptions, getMetadataArgsStorage, useExpressServer } from \"routing-controllers\";\nimport { errorMiddleware, getAuthenticator } from \"@panenco/papi\";\nimport { validationMetadatasToSchemas } from 'class-validator-jsonschema';\nimport { getMetadataStorage } from 'class-validator';\nimport { routingControllersToSpec } from 'routing-controllers-openapi';\nimport swaggerUi from 'swagger-ui-express';\nimport { MikroORM, RequestContext } from '@mikro-orm/core';\nimport ormConfig from './orm.config.js';\nimport { PostgreSqlDriver } from '@mikro-orm/postgresql';\n\n\nexport class App {\n  host: Application;\n  public orm: MikroORM<PostgreSqlDriver>;\n\n  constructor() {\n    // Init server\n    this.host = express();\n\n    // Allow json body\n    this.host.use(express.json());\n\n    // Example root endpoint\n    this.host.get(\"/\", (req: Request, res: Response) => {\n      res.send(\"Hello World!\");\n    });\n\n    // Custom before middleware\n    this.host.use((req: Request, res: Response, next: NextFunction) => {\n      console.log(req.method, req.url);\n      next();\n    });\n\n    this.initializeControllers([UserController, AuthController]);\n\n    // Custom after middleware (only used when res.send or json is not called in a previous middleware (no endpoint found))\n    this.host.use((req: Request, res: Response, next: NextFunction) => {\n      res.status(404).send(\"No Endpoint found\");\n    });\n\n    this.host.use(errorMiddleware);\n    this.host.use((req, __, next: NextFunction) => {\n      RequestContext.create(this.orm.em, next);\n    });\n  }\n\n  public async createConnection() {\n\t\ttry {\n\t\t\tthis.orm = await MikroORM.init(ormConfig);\n\t\t} catch (error) {\n\t\t\tconsole.log('Error while connecting to the database', error);\n\t\t}\n\t}\n\n  private initializeControllers(controllers: Function[]) {\n    useExpressServer(this.host, { // Link the express host to routing-controllers\n      cors: {\n        origin: \"*\", // Allow all origins, any application on any url can call our api. This is why we also added the `cors` package.\n        exposedHeaders: [\"x-auth\"], // Allow the header `x-auth` to be exposed to the client. This is needed for the authentication to work later.\n      },\n      controllers, // Provide the controllers. Currently this won't work yet, first we need to convert the Route to a routing-controllers controller.\n      defaultErrorHandler: false, // Disable the default error handler. We will handle errors through papi later.\n      routePrefix: \"/api\", // Map all routes to the `/api` path.\n      authorizationChecker: getAuthenticator('jwtSecretFromConfigHere'), // Tell routing-controllers to use the papi authentication checker\n    });\n }\n\n  private initializeSwagger() {\n    const schemas = validationMetadatasToSchemas({\n      classValidatorMetadataStorage: getMetadataStorage(),\n      refPointerPrefix: \"#/components/schemas/\",\n    });\n\n    const routingControllersOptions: RoutingControllersOptions = {\n      routePrefix: \"/api\",\n    };\n\n    const storage = getMetadataArgsStorage();\n\n    const spec = routingControllersToSpec(storage, routingControllersOptions, {\n      components: {\n        schemas,\n        securitySchemes: {\n          JWT: {\n            in: \"header\",\n            name: \"x-auth\",\n            type: \"apiKey\",\n            bearerFormat: \"JWT\",\n            description: \"JWT Authorization header using the JWT scheme. Example: \\\"x-auth: {token}\\\"\",\n          },\n        },\n      },\n      security: [{JWT: []}],\n    });\n\n    this.host.use('/docs', swaggerUi.serve, swaggerUi.setup(spec));\n  } \n\n  listen() {\n    this.host.listen(3000, () => {\n      console.info(`ðŸš€ http://localhost:3000`);\n      console.info(`=================================`);\n    });\n  }\n}\n"],"names":["express","UserController","AuthController","getMetadataArgsStorage","useExpressServer","errorMiddleware","getAuthenticator","validationMetadatasToSchemas","getMetadataStorage","routingControllersToSpec","swaggerUi","MikroORM","RequestContext","ormConfig","App","host","orm","constructor","use","json","get","req","res","send","next","console","log","method","url","initializeControllers","status","__","create","em","createConnection","init","error","controllers","cors","origin","exposedHeaders","defaultErrorHandler","routePrefix","authorizationChecker","initializeSwagger","schemas","classValidatorMetadataStorage","refPointerPrefix","routingControllersOptions","storage","spec","components","securitySchemes","JWT","in","name","type","bearerFormat","description","security","serve","setup","listen","info"],"mappings":"AAAA,OAAO,uBAAuB;AAC9B,6BAA6B;AAC7B,OAAOA,aAA+D,UAAU;AAEhF,SAASC,cAAc,QAAQ,yCAAyC;AACxE,OAAOC,oBAAoB,wCAAwC;AACnE,SAAoCC,sBAAsB,EAAEC,gBAAgB,QAAQ,sBAAsB;AAC1G,SAASC,eAAe,EAAEC,gBAAgB,QAAQ,gBAAgB;AAClE,SAASC,4BAA4B,QAAQ,6BAA6B;AAC1E,SAASC,kBAAkB,QAAQ,kBAAkB;AACrD,SAASC,wBAAwB,QAAQ,8BAA8B;AACvE,OAAOC,eAAe,qBAAqB;AAC3C,SAASC,QAAQ,EAAEC,cAAc,QAAQ,kBAAkB;AAC3D,OAAOC,eAAe,kBAAkB;AAIxC,OAAO,MAAMC;IACXC,KAAkB;IACXC,IAAgC;IAEvCC,aAAc;QACZ,cAAc;QACd,IAAI,CAACF,IAAI,GAAGf;QAEZ,kBAAkB;QAClB,IAAI,CAACe,IAAI,CAACG,GAAG,CAAClB,QAAQmB,IAAI;QAE1B,wBAAwB;QACxB,IAAI,CAACJ,IAAI,CAACK,GAAG,CAAC,KAAK,CAACC,KAAcC;YAChCA,IAAIC,IAAI,CAAC;QACX;QAEA,2BAA2B;QAC3B,IAAI,CAACR,IAAI,CAACG,GAAG,CAAC,CAACG,KAAcC,KAAeE;YAC1CC,QAAQC,GAAG,CAACL,IAAIM,MAAM,EAAEN,IAAIO,GAAG;YAC/BJ;QACF;QAEA,IAAI,CAACK,qBAAqB,CAAC;YAAC5B;YAAgBC;SAAe;QAE3D,uHAAuH;QACvH,IAAI,CAACa,IAAI,CAACG,GAAG,CAAC,CAACG,KAAcC,KAAeE;YAC1CF,IAAIQ,MAAM,CAAC,KAAKP,IAAI,CAAC;QACvB;QAEA,IAAI,CAACR,IAAI,CAACG,GAAG,CAACb;QACd,IAAI,CAACU,IAAI,CAACG,GAAG,CAAC,CAACG,KAAKU,IAAIP;YACtBZ,eAAeoB,MAAM,CAAC,IAAI,CAAChB,GAAG,CAACiB,EAAE,EAAET;QACrC;IACF;IAEA,MAAaU,mBAAmB;QAChC,IAAI;YACH,IAAI,CAAClB,GAAG,GAAG,MAAML,SAASwB,IAAI,CAACtB;QAChC,EAAE,OAAOuB,OAAO;YACfX,QAAQC,GAAG,CAAC,0CAA0CU;QACvD;IACD;IAESP,sBAAsBQ,WAAuB,EAAE;QACrDjC,iBAAiB,IAAI,CAACW,IAAI,EAAE;YAC1BuB,MAAM;gBACJC,QAAQ;gBACRC,gBAAgB;oBAAC;iBAAS;YAC5B;YACAH;YACAI,qBAAqB;YACrBC,aAAa;YACbC,sBAAsBrC,iBAAiB;QACzC;IACH;IAESsC,oBAAoB;QAC1B,MAAMC,UAAUtC,6BAA6B;YAC3CuC,+BAA+BtC;YAC/BuC,kBAAkB;QACpB;QAEA,MAAMC,4BAAuD;YAC3DN,aAAa;QACf;QAEA,MAAMO,UAAU9C;QAEhB,MAAM+C,OAAOzC,yBAAyBwC,SAASD,2BAA2B;YACxEG,YAAY;gBACVN;gBACAO,iBAAiB;oBACfC,KAAK;wBACHC,IAAI;wBACJC,MAAM;wBACNC,MAAM;wBACNC,cAAc;wBACdC,aAAa;oBACf;gBACF;YACF;YACAC,UAAU;gBAAC;oBAACN,KAAK,EAAE;gBAAA;aAAE;QACvB;QAEA,IAAI,CAACtC,IAAI,CAACG,GAAG,CAAC,SAASR,UAAUkD,KAAK,EAAElD,UAAUmD,KAAK,CAACX;IAC1D;IAEAY,SAAS;QACP,IAAI,CAAC/C,IAAI,CAAC+C,MAAM,CAAC,MAAM;YACrBrC,QAAQsC,IAAI,CAAC,CAAC,wBAAwB,CAAC;YACvCtC,QAAQsC,IAAI,CAAC,CAAC,iCAAiC,CAAC;QAClD;IACF;AACF"}